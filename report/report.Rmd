---
title: '2016 Brussels Bombings'
subtitle: 'Air Traffic Analysis'
author:
- '[Ramiro Balado Ordax](https://github.com/Qjammer)'
- '[Alejandro Hernández Rubio](https://github.com/Shyryuu)'
- '[Pol Mesalles Ripoll](https://github.com/polmes)'
output:
    rmarkdown::html_document:
        theme: cosmo
        highlight: tango
        number_sections: true
        toc: true
        toc_float: true
        css: styles.css
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Air Traffic

## Air Traffic Evolution {.tabset .tabset-fade}

```{r, fig.align='center'}
ddr.times(data$real$flights, bru, event)
```

- Traffic before the attacks: `r floor(before[orig == bru, mean(N.x + N.y)])` average daily flights (including departures and arrivals)
- Traffic after the attacks: `r floor(after[orig == bru, mean(N.x + N.y)])` average daily flights (including departures and arrivals)

Even one month after the event, the traffic is still lower. Overall, the traffic is reduced in a `r format(abs((after[orig == bru, mean(N.x + N.y)] - before[orig == bru, mean(N.x + N.y)]) / before[orig == bru, mean(N.x + N.y)]) * 100, digits = 3)`% following the tragic events. Further details can be extracted from the figure below:

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = before[orig == bru], aes(x = 'Before')) +
	stat_summary(data = before[orig == bru], aes(x = 'Before'),
				 fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	geom_boxplot(data = after[orig == bru], aes(x = 'After')) +
	stat_summary(data = after[orig == bru], aes(x = 'After'),
				 fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	scale_x_discrete(limits = c('Before', 'After')) +
	labs(title = paste('Average Daily Flights at', bru), x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5))
```

Bizarrely, despite the airport supposedly being closed from March 22 to April 3, the number of flights during the days following the attack is non-zero. Let's take a closer look at these flights:

### EBBR Departures {-}

```{r}
datatable(ufo[orig == bru, .(dest, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Destination', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString', params = list('ca-ES'))
```

### EBBR Arrivals {-}

```{r}
datatable(ufo[dest == bru, .(orig, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Origin', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString')
```

## Diverted Flights {.tabset .tabset-fade}

On the day of the event, March 22, 2016, there were a total of `r div[, .N]` diverted flights that had intended to land on Brussels Airport (EBBR).

```{r, fig.align='center'}
datatable(div[, .(orig, dest, airline, diff, fuel)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Origin', 'Destination', 'Airline', 'Distance Delta (NM)', 'Fuel Delta (kg)')) %>%
	formatRound(columns = c('diff', 'fuel'), digits = 2)
```

On average, airlines actually saved `r format(abs(div[, mean(fuel)]), digits = 3)` kg of fuel by diverting flights to airports closer to the origin point.

### Static Map {-}

```{r, fig.align='center'}
ddr.map(data$real$routes[id %in% div[, id]], autocenter = FALSE)
```

### Interactive Map {-}

```{r, fig.align='center'}
ddr.jsmap(data$real$routes[id %in% div[, id]], div, coord, data$plan$routes[id %in% div[, id]])
```

### Animation {-}

```{r, message=FALSE, results=FALSE}
gifname <- 'diverted'
giffile <- file.path('..', 'data', paste0(gifname, '.gif'))
if (!file.exists(giffile)) {
	ddr.animate(data$real$routes[id %in% div[, id]], giffile)
}
```
![Diverted Flights Map Animation](`r giffile`) \


# Airports

The nearby airports to EBBR include:

- EBCI (Brussels South Charleroi)
- EBLG (Liège)
- EBAW (Antwerp)
- EHEH (Eindhoven)
- LFQQ (Lille)

## Traffic in nearby airports

```{r, fig.align='center'}
htmltools::tagList(lapply(nearby, function(airport) {
	ddr.times(data$real$flights, airport, event, group = 'nearby', height = '250px')
}))
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = before[orig != bru], aes(x = orig, color = 'before')) +
	geom_boxplot(data = during, aes(x = orig, color = 'during')) +
	geom_boxplot(data = after[orig != bru], aes(x = orig, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = nearby) +
	labs(title = 'Average Daily Flights in Nearby Airports', x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, results='asis'}
for (airport in nearby) {
	cat(paste('-', airport, 'traffic:\n\t*', paste0(sprintf('%+.1f', (during[orig == airport, mean(N.x + N.y)] - before[orig == airport, mean(N.x + N.y)]) / before[orig == airport, mean(N.x + N.y)] * 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t*', paste0(sprintf('%+.1f', (after[orig == airport, mean(N.x + N.y)] - before[orig == airport, mean(N.x + N.y)]) / before[orig == airport, mean(N.x + N.y)] * 100), '%'), 'after', bru, 'reopens with respect to before the attack\n'))
}
```

## Delays

```{r, fig.align='center'}
htmltools::tagList(lapply(c(bru, nearby), function(icao) {
	dygraph(delays[airport == icao, .(date, depdel, arrdel)],
			main = paste('Average Daily Delays at', icao),
			ylab = paste('Delay (seconds)'),
			group = 'delay',
			width = '100%', height = '250px') %>%
		dySeries('depdel', label = paste('Delay in Departures')) %>%
		dySeries('arrdel', label = paste('Delay in Arrivals')) %>%
		dyRangeSelector() %>%
		dyOptions(colors = c('royalblue', 'coral')) %>%
		dyLegend(width = '380') %>%
		dyEvent(event[1], 'Airport closes', labelLoc = 'bottom') %>%
		dyEvent(event[2], 'Airport reopens', labelLoc = 'bottom')
}))
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = depdel)) +
	geom_boxplot(data = delays[date < event[1]], aes(x = airport, color = 'before')) +
	geom_boxplot(data = delays[date >= event[1] & date <= event[2]], aes(x = airport, color = 'during')) +
	geom_boxplot(data = delays[date > event[2]], aes(x = airport, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = c(bru, nearby)) +
	labs(title = 'Average Daily Departure Delays', x = NULL, y = 'Delay (seconds)') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = arrdel)) +
	geom_boxplot(data = delays[date < event[1]], aes(x = airport, color = 'before')) +
	geom_boxplot(data = delays[date >= event[1] & date <= event[2]], aes(x = airport, color = 'during')) +
	geom_boxplot(data = delays[date > event[2]], aes(x = airport, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = c(bru, nearby)) +
	labs(title = 'Average Daily Arrival Delays', x = NULL, y = 'Delay (seconds)') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, results='asis'}
for (icao in c(bru, nearby)) {
	cat(paste('-', icao, 'delays:\n\t- Departures:\n\t\t*', paste0(sprintf('%+.1f', (delays[airport == icao & (date >= event[1] & date <= event[2]), mean(depdel)] - delays[airport == icao & date < event[1], mean(depdel)]) / delays[airport == icao & date < event[1], mean(depdel)] * 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t\t*', paste0(sprintf('%+.1f', (delays[airport == icao & date > event[2], mean(depdel)] - delays[airport == icao & date < event[1], mean(depdel)]) / delays[airport == icao & date < event[1], mean(depdel)] * 100), '%'), 'after', bru, 'reopens with respect to before the attack\n\t- Arrivals:\n\t\t*', paste0(sprintf('%+.1f', (delays[airport == icao & (date >= event[1] & date <= event[2]), mean(arrdel)] - delays[airport == icao & date < event[1], mean(arrdel)]) / delays[airport == icao & date < event[1], mean(arrdel)] * 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t\t*', paste0(sprintf('%+.1f', delays[airport == icao & date > event[2], mean(arrdel)] / delays[airport == icao & date < event[1], mean(arrdel)] * 100 + 100), '%'), 'after', bru, 'reopens with respect to before the attack\n'))
}
```

# Airlines

- Find from total flights the airlines that were most affected (from those that travel to EBBR)
- Average delays (while EBBR closed) by airline
