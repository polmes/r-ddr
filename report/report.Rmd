---
title: '<header style="text-align: center">
			<h1 style="font-weight: bold; font-size: 44px" class="toc-ignore">2016 Brussels Bombings</h1>
			<h2 class="toc-ignore">Air Traffic Analysis</h2>
		</header>'
author: '<div style="text-align: center">
			<span style="display: inline-block; width: 30%; margin: 0 5px">[Ramiro Balado Ordax](https://github.com/Qjammer)</span>
			<span style="display: inline-block; width: 30%; margin: 0 5px">[Alejandro Hernández Rubio](https://github.com/Shyryuu)</span>
			<span style="display: inline-block; width: 30%; margin: 0 5px">[Pol Mesalles Ripoll](https://github.com/polmes)</span>
		</div>'
# date: "DD/MM/YYYY"
output:
    rmarkdown::html_document:
        theme: cosmo
        highlight: tango
        number_sections: true
        toc: true
        toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Air Traffic

## Air Traffic Evolution {.tabset .tabset-fade}

```{r, fig.align='center'}
ddr.times(data$real$flights, bru, event)
```

- Traffic before the attacks: `r floor(before[, mean(N.x + N.y)])` average daily flights (including departures and arrivals)
- Traffic after the attacks: `r floor(after[, mean(N.x + N.y)])` average daily flights (including departures and arrivals)

Even one month after the event, the traffic is still lower. Overall, the traffic is reduced in a `r format(abs((after[, mean(N.x + N.y)] - before[, mean(N.x + N.y)]) / before[, mean(N.x + N.y)]) * 100, digits = 3)`% following the tragic events. Further details can be extracted from the figure below:

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = before, aes(x = 'Before')) +
	stat_summary(data = before, aes(x = 'Before'), fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	geom_boxplot(data = after, aes(x = 'After')) +
	stat_summary(data = after, aes(x = 'After'), fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	scale_x_discrete(limits = c('Before', 'After')) +
	labs(title = paste('Average Daily Flights at', bru), x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5))
```

Bizarrely, despite the airport supposedly being closed from March 22 to April 3, the number of flights during the days following the attack is non-zero. Let's take a closer look at these flights:

### EBBR Departures {-}

```{r}
datatable(ufo[orig == bru, .(dest, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Destination', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString')
```

### EBBR Arrivals {-}

```{r}
datatable(ufo[dest == bru, .(orig, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Origin', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString')
```

## Diverted Flights {.tabset .tabset-fade}

On the day of the event, March 22, 2016, there were a total of `r div[, .N]` diverted flights that had intended to land on Brussels Airport (EBBR).

```{r, fig.align='center'}
datatable(div[, .(orig, dest, airline, diff, fuel)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), colnames = c('Origin', 'Destination', 'Airline', 'Distance Delta (NM)', 'Fuel Delta (kg)')) %>%
	formatRound(columns = c('diff', 'fuel'), digits = 2)
```

On average, airlines actually saved `r format(abs(div[, mean(fuel)]), digits = 3)` kg of fuel by diverting flights to airports closer to the origin point.

### Static Map {-}

```{r, fig.align='center'}
ddr.map(data$real$routes[id %in% div[, id]], autocenter = FALSE)
```

### Interactive Map {-}

```{r, fig.align='center'}
ddr.jsmap(data$real$routes[id %in% div[, id]], div, coord)
```

### Animation {-}

```{r, message=FALSE, results=FALSE}
gifname <- 'diverted'
giffile <- file.path('..', 'data', paste0(gifname, '.gif'))
if (!file.exists(giffile)) {
	ddr.animate(data$real$routes[id %in% div[, id]], giffile)
}
```
![Diverted Flights Map Animation](`r giffile`) \


# Airports

The nearby airports to EBBR include:

- EBCI (Brussels South Charleroi)
- EBLG (Liège)
- EBAW (Antwerp)
- EHEH (Eindhoven)
- LFQQ (Lille)

## Traffic in nearby airports

```{r, fig.align='center'}
htmltools::tagList(lapply(nearby, function(airport) {
	ddr.times(data$real$flights, airport, event, group = 'nearby', height = '250px')
}))
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = befores, aes(x = orig, color = 'before')) +
	geom_boxplot(data = durings, aes(x = orig, color = 'during')) +
	geom_boxplot(data = afters, aes(x = orig, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	labs(title = 'Average Daily Flights in Nearby Airports', x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, results='asis'}
for (airport in nearby) {
	cat(paste('-', airport, 'traffic:\n\t*', paste0(sprintf('%+.1f', (afters[orig == airport, mean(N.x + N.y)] - befores[orig == airport, mean(N.x + N.y)]) / befores[orig == airport, mean(N.x + N.y)] * 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t*', paste0(sprintf('%+.1f', (durings[orig == airport, mean(N.x + N.y)] - befores[orig == airport, mean(N.x + N.y)]) / befores[orig == airport, mean(N.x + N.y)] * 100), '%'), 'after', bru, 'reopens with respect to before the attack\n'))
}
```

## Delays in nearby airports

- Delays on each airport vs. time (per hour)
- Boxplot (mean + sigma) comparing average delays on each airport (while EBBR closed)
- Find average delay before/during/after

# Airlines

- Find from total flights the airlines that were most affected (from those that travel to EBBR)
- Average delays (while EBBR closed) by airline
