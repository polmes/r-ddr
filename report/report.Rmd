---
title: '2016 Brussels Bombings'
subtitle: 'Air Traffic Analysis'
author:
- '[Ramiro Balado Ordax](https://github.com/Qjammer)'
- '[Alejandro Hernández Rubio](https://github.com/Shyryuu)'
- '[Pol Mesalles Ripoll](https://github.com/polmes)'
output:
    rmarkdown::html_document:
        theme: cosmo
        highlight: tango
        number_sections: true
        toc: true
        toc_float: true
        css: styles.css
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction {-}

On Tuesday the 22nd of March, 2016, three suicidal terrorist attacks struck Brussels. Two of the explosions happened at 7:58am inside the main terminal of the Zaventem international airport (ICAO: EBBR, IATA: BRU), while the last blast struck the Maelbeek metro station in the city center an hour later.

Following the incident, the airport closed until the 3rd of April, when it reopened again under a few restrictions. Many european countries reacted, including Germany, by stepping up security measures at points of high risk.

The attack, that took the lives of 32 people and injured 340 more, raised the terrorist threat levels to "Severe", which symbolized a high possibility of attack.

This study presents the results of an in-depth analysis of the air activity before, during and after the incident, addressing the effects of the shutdown of Brussels’ only international airport, as well as the fear that the attack induced after it.

# Air Traffic

## Brussels Airport {.tabset .tabset-fade}

```{r, fig.align='center'}
ddr.times(data$real$flights, bru, event)
```

- Traffic before the attacks: `r round(before[orig == bru, mean(N.x + N.y)])` average daily flights (including departures and arrivals)
- Traffic after the attacks: `r round(after[orig == bru, mean(N.x + N.y)])` average daily flights (including departures and arrivals)

Even one month after the event, the traffic is still lower. Overall, the traffic is reduced in a `r format(abs((after[orig == bru, mean(N.x + N.y)] - before[orig == bru, mean(N.x + N.y)]) / before[orig == bru, mean(N.x + N.y)]) * 100, digits = 3)`% following the tragic events. Further details can be extracted from the figure below:

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = before[orig == bru], aes(x = 'Before')) +
	stat_summary(data = before[orig == bru], aes(x = 'Before'),
				 fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	geom_boxplot(data = after[orig == bru], aes(x = 'After')) +
	stat_summary(data = after[orig == bru], aes(x = 'After'),
				 fun.y = mean, geom = 'point', shape = 5, size = 2.5) +
	scale_x_discrete(limits = c('Before', 'After')) +
	labs(title = paste('Average Daily Flights at', bru), x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5))
```

Bizarrely, despite the airport supposedly being closed from March 22 to April 3, the number of flights during the days following the attack is non-zero. Let's take a closer look at these flights:

### EBBR Departures {-}

```{r}
datatable(ufo[orig == bru, .(dest, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), rownames = FALSE, colnames = c('Destination', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString', params = list('ca-ES'))
```

### EBBR Arrivals {-}

```{r}
datatable(ufo[dest == bru, .(orig, airline, aircraft, takeoff, landing)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), rownames = FALSE, colnames = c('Origin', 'Airline', 'Aircraft', 'Departure', 'Arrival')) %>%
	formatDate(columns = c('takeoff', 'landing'), method = 'toLocaleString')
```

## Diverted Flights {.tabset .tabset-fade}

On the day of the event, March 22, 2016, there were a total of `r div[, .N]` diverted flights that had intended to land on Brussels Airport (EBBR).

```{r, fig.align='center'}
datatable(div[, .(orig, dest, airline, diff, fuel)], options = list(dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), rownames = FALSE, colnames = c('Origin', 'Destination', 'Airline', 'Distance Delta (NM)', 'Fuel Delta (kg)')) %>%
	formatRound(columns = c('diff', 'fuel'), digits = 2)
```

On average, airlines actually saved `r format(abs(div[, mean(fuel)]), digits = 3)` kg of fuel by diverting flights to airports closer to the origin point. However, costs related to those diverted flights such as compensations to passengers strongly outweigh those related to fuel consumption.

The maps below display the routes followed by these diverted flights.

### Static Map {-}

```{r, fig.align='center'}
ddr.map(data$real$routes[id %in% div[, id]], autocenter = FALSE)
```

### Interactive Map {-}

```{r, fig.align='center'}
ddr.jsmap(data$real$routes[id %in% div[, id]], div, coord, data$plan$routes[id %in% div[, id]])
```

### Animation {-}

```{r, message=FALSE, results=FALSE}
divname <- 'diverted'
divfile <- file.path('..', 'data', paste0(divname, '.gif'))
if (!file.exists(divfile)) {
	ddr.animate(data$real$routes[id %in% div[, id]], divfile)
}
```
![Diverted Flights Map Animation](`r divfile`) \


## European Sky

```{r, fig.align='center'}
dygraph(eu, main = 'European Air Traffic Evolution', ylab = 'Total Number of Flights', width = '100%') %>%
	dyRangeSelector() %>%
	dyLegend(width = '160') %>%
	dyEvent(event[1], 'Airport closes', labelLoc = 'bottom') %>%
	dyEvent(event[2], 'Airport reopens', labelLoc = 'bottom')
```

- Average traffic before the attacks: `r format(round(mean(eu[date < event[1], N])))` flights per day
- Average traffic while `r bru` was closed: `r format(round(mean(eu[date >= event[1] & date <= event[2], N])))` flights per day (`r  sprintf('%+.1f', mean(eu[date >= event[1] & date <= event[2], N]) / mean(eu[date < event[1], N]) * 100 - 100)`% with respect to before the attack)
- Average traffic after `r bru` reopens: `r format(round(mean(eu[date > event[2], N])))` flights per day (`r  sprintf('%+.1f', mean(eu[date > event[2], N]) / mean(eu[date < event[1], N]) * 100 - 100)`% with respect to before the attack)

```{r, message=FALSE, results=FALSE}
euname <- 'belgium'
eufile <- file.path('..', 'data', paste0(euname, '.gif'))
if (!file.exists(eufile)) {
	ddr.animate(data$real$routes[id %in% data$real$flights[as.Date(takeoff) == event[1], id]], eufile, nf = 1000, autocenter = FALSE)
}
```
![European Traffic Map Animation](`r eufile`) \

Comparing the traffic evolution to another European airport, like Barcelona (IATA: BCN, ICAO: LEBL)...

```{r, fig.align='center'}
ddr.times(data$real$flights, bcn, event)
```

- Average traffic before the attacks: `r round(before[orig == bcn, mean(N.x + N.y)])` flights per day (including departures and arrivals)
- Average traffic while `r bru` was closed: `r round(during[orig == bcn, mean(N.x + N.y)])` flights per day (including departures and arrivals; `r  sprintf('%+.1f', during[orig == bcn, mean(N.x + N.y)] / before[orig == bcn, mean(N.x + N.y)] * 100 - 100)`% with respect to before the attack)
- Average traffic after `r bru` reopens: `r after[orig == bcn, mean(N.x + N.y)]` flights per day (including departures and arrivals; `r  sprintf('%+.1f', after[orig == bcn, mean(N.x + N.y)] / before[orig == bcn, mean(N.x + N.y)] * 100 - 100)`% with respect to before the attack)

# Airports

The nearby airports to EBBR include:

- EBCI (Brussels South Charleroi)
- EBLG (Liège)
- EBAW (Antwerp)
- EHEH (Eindhoven)
- LFQQ (Lille)

## Traffic in nearby airports

```{r, fig.align='center'}
htmltools::tagList(lapply(nearby, function(airport) {
	ddr.times(data$real$flights, airport, event, group = 'nearby', height = '250px')
}))
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = N.x + N.y)) +
	geom_boxplot(data = before[orig %in% nearby], aes(x = orig, color = 'before')) +
	geom_boxplot(data = during[orig %in% nearby], aes(x = orig, color = 'during')) +
	geom_boxplot(data = after[orig %in% nearby], aes(x = orig, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = nearby) +
	labs(title = 'Average Daily Flights in Nearby Airports', x = NULL, y = 'Number of Flights') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, results='asis'}
for (airport in nearby) {
	cat(paste('-', airport, 'traffic:\n\t*', paste0(sprintf('%+.1f', during[orig == airport, mean(N.x + N.y)] / before[orig == airport, mean(N.x + N.y)] * 100 - 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t*', paste0(sprintf('%+.1f', after[orig == airport, mean(N.x + N.y)] / before[orig == airport, mean(N.x + N.y)] * 100 - 100), '%'), 'after', bru, 'reopens with respect to before the attack\n'))
}
```

## Delays

```{r, fig.align='center'}
htmltools::tagList(lapply(c(bru, nearby), function(icao) {
	dygraph(delays[airport == icao, .(date, depdel, arrdel)],
			main = paste('Average Daily Delays at', icao),
			ylab = paste('Delay (seconds)'),
			group = 'delay',
			width = '100%', height = '250px') %>%
		dySeries('depdel', label = paste('Delay in Departures')) %>%
		dySeries('arrdel', label = paste('Delay in Arrivals')) %>%
		dyRangeSelector() %>%
		dyOptions(colors = c('royalblue', 'coral')) %>%
		dyLegend(width = '380') %>%
		dyEvent(event[1], 'Airport closes', labelLoc = 'bottom') %>%
		dyEvent(event[2], 'Airport reopens', labelLoc = 'bottom')
}))
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = depdel)) +
	geom_boxplot(data = delays[date < event[1]], aes(x = airport, color = 'before')) +
	geom_boxplot(data = delays[date >= event[1] & date <= event[2]], aes(x = airport, color = 'during')) +
	geom_boxplot(data = delays[date > event[2]], aes(x = airport, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = c(bru, nearby)) +
	labs(title = 'Average Daily Departure Delays', x = NULL, y = 'Delay (seconds)') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, fig.align='center'}
ggplot(data = NULL, aes(y = arrdel)) +
	geom_boxplot(data = delays[date < event[1]], aes(x = airport, color = 'before')) +
	geom_boxplot(data = delays[date >= event[1] & date <= event[2]], aes(x = airport, color = 'during')) +
	geom_boxplot(data = delays[date > event[2]], aes(x = airport, color = 'after')) +
	scale_color_manual(limits = c('before', 'during', 'after'), values = c('green', 'red', 'blue'),
					   name = NULL, labels = c('Before the attack', paste('While', bru, 'closed'),
					   						   paste('After', bru, 'reopens'))) +
	scale_x_discrete(limits = c(bru, nearby)) +
	labs(title = 'Average Daily Arrival Delays', x = NULL, y = 'Delay (seconds)') +
	theme(plot.title = element_text(hjust = 0.5), legend.position = 'bottom')
```

```{r, results='asis'}
for (icao in c(bru, nearby)) {
	cat(paste('-', icao, 'delays:\n\t- Departures:\n\t\t*', paste0(sprintf('%+.1f', delays[airport == icao & (date >= event[1] & date <= event[2]), mean(depdel)] / delays[airport == icao & date < event[1], mean(depdel)] * 100 - 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t\t*', paste0(sprintf('%+.1f', delays[airport == icao & date > event[2], mean(depdel)] / delays[airport == icao & date < event[1], mean(depdel)] * 100 - 100), '%'), 'after', bru, 'reopens with respect to before the attack\n\t- Arrivals:\n\t\t*', paste0(sprintf('%+.1f', delays[airport == icao & (date >= event[1] & date <= event[2]), mean(arrdel)] / delays[airport == icao & date < event[1], mean(arrdel)] * 100 - 100), '%'), 'while', bru, 'was closed with respect to before the attack\n\t\t*', paste0(sprintf('%+.1f', delays[airport == icao & date > event[2], mean(arrdel)] / delays[airport == icao & date < event[1], mean(arrdel)] * 100 - 100), '%'), 'after', bru, 'reopens with respect to before the attack\n'))
}
```

# Airlines

```{r}
datatable(fucked, options = list(order = list(list(6, 'asc')), dom = 'tp', columnDefs = list(list(className = 'dt-center', targets = '_all'))), rownames = FALSE, colnames = c('Airline', 'ICAO Code', 'Flights Before', 'Flights During', 'Flights After', 'Delta During', 'Delta After', '% During', '% After')) %>%
	formatPercentage(columns = c('bd_rel', 'ba_rel'), digits = 1)
```

```{r, fig.align='center'}
dygraph(fuckedplot,
		main = 'Most Affected Airlines',
		ylab = 'Number of Flights',
		width = '100%') %>%
	dyRangeSelector() %>%
	dyLegend(width = '360') %>%
	dyEvent(event[1], 'Airport closes', labelLoc = 'bottom') %>%
	dyEvent(event[2], 'Airport reopens', labelLoc = 'bottom')
```

# Final Notes {-}

The R code developed for this project and used to render this report is freely available on [GitHub](https://github.com/polmes/r-ddr) under an MIT license.

During the development of this study, one of the main issues has been the unreliability of the DDR2 platform, generating incomplete data at times, or simply not allowing all of us to generate downloads, no matter the time.

At least RStudio will be [better](https://github.com/rstudio/rstudio/pull/4809) soon with our help.
